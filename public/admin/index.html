<!doctype html>
<html lang="zh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GM后台 - 文字传奇</title>
  <link rel="stylesheet" href="admin.css?v=3">
</head>
<body>
  <div class="wrap">
    <header>
      <h1>GM 后台</h1>
      <p>账号、角色、邮件、VIP 管理</p>
      <div class="header-actions">
        <button id="theme-toggle" class="btn-small">切换暗色</button>
        <button id="collapse-all" class="btn-small">折叠全部</button>
      </div>
    </header>

    <section id="login" class="panel">
      <h2>管理员登录</h2>
      <input id="admin-user" type="text" placeholder="管理员账号">
      <input id="admin-pass" type="password" placeholder="管理员密码">
      <button id="admin-login-btn">登录</button>
      <div id="login-msg" class="msg"></div>
    </section>

    <section id="dashboard" class="panel hidden">
      <div class="grid">
        <div class="block full" data-collapsible>
          <div class="block-title">
            <h2>区服管理</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <div class="row" style="margin-bottom: 8px;">
              <input id="realm-name-input" type="text" placeholder="区服名称" style="max-width: 200px;">
              <button id="realm-create-btn" class="btn-small">创建新区</button>
              <button id="realm-refresh-btn" class="btn-small">刷新列表</button>
              <button id="fix-realm-btn" class="btn-small" style="background: #ff9800;">修复旧数据</button>
            </div>
            <table id="realms-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>区名</th>
                  <th>角色数</th>
                  <th>行会数</th>
                  <th>创建时间</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="realms-list">
                <tr>
                  <td colspan="6" style="text-align: center; color: #999;">加载中...</td>
                </tr>
              </tbody>
            </table>
            <div id="realms-msg" class="msg"></div>
          </div>
        </div>

        <div class="block full" data-collapsible>
          <div class="block-title">
            <h2>用户与权限</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
          <div class="row">
            <button id="refresh-users">刷新列表</button>
          </div>
          <div class="table-container">
            <div class="row" style="margin-bottom: 8px;">
              <input id="users-search" type="text" placeholder="搜索用户名">
              <button id="users-search-btn" class="btn-small">搜索</button>
            </div>
            <table id="users-table">
              <thead>
                <tr>
                  <th>用户名</th>
                  <th>GM权限</th>
                  <th>创建时间</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="users-list">
                <tr>
                  <td colspan="4" style="text-align: center; color: #999;">加载中...</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="row" style="margin-top: 12px;">
            <div id="users-pagination-info" style="color: #666;"></div>
            <div>
              <button id="users-prev-page" class="btn-small">上一页</button>
              <button id="users-next-page" class="btn-small">下一页</button>
            </div>
          </div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>世界BOSS设置</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <p style="color: #666; margin-bottom: 6px; font-size: 13px;">基础属性</p>
            <div class="row" style="margin-bottom: 4px; font-size: 13px; gap: 4px;">
              <label style="min-width: 40px;">生命:</label>
              <input id="wb-base-hp" type="number" min="1" style="width: 90px; font-size: 13px; padding: 4px 6px;">
              <label style="min-width: 40px;">攻击:</label>
              <input id="wb-base-atk" type="number" min="1" style="width: 90px; font-size: 13px; padding: 4px 6px;">
            </div>
            <div class="row" style="margin-bottom: 4px; font-size: 13px; gap: 4px;">
              <label style="min-width: 40px;">防御:</label>
              <input id="wb-base-def" type="number" min="1" style="width: 90px; font-size: 13px; padding: 4px 6px;">
              <label style="min-width: 40px;">魔御:</label>
              <input id="wb-base-mdef" type="number" min="1" style="width: 90px; font-size: 13px; padding: 4px 6px;">
            </div>
            <div class="row" style="margin-bottom: 6px; font-size: 13px; gap: 4px;">
              <label style="min-width: 40px;">掉落加成:</label>
              <input id="wb-drop-bonus" type="number" min="1" step="0.1" style="width: 90px; font-size: 13px; padding: 4px 6px;">
            </div>

            <p style="color: #666; margin: 10px 0 6px; font-size: 13px;">人数加成配置</p>
            <div class="table-container">
              <table style="font-size: 12px;">
                <thead>
                  <tr>
                    <th style="padding: 6px 8px;">最小人数</th>
                    <th style="padding: 6px 8px;">生命加成</th>
                    <th style="padding: 6px 8px;">攻击加成</th>
                    <th style="padding: 6px 8px;">防御加成</th>
                    <th style="padding: 6px 8px;">魔御加成</th>
                    <th style="padding: 6px 8px;">操作</th>
                  </tr>
                </thead>
                <tbody id="wb-player-bonus-list">
                  <tr>
                    <td colspan="6" style="text-align: center; color: #999;">点击加载获取数据</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="row" style="margin-top: 8px;">
              <button id="wb-add-bonus-btn" class="btn-small">+ 添加配置</button>
              <button id="wb-respawn-btn" class="btn-small">刷新BOSS</button>
              <button id="wb-save-btn" class="btn-small">保存</button>
            </div>
            <div id="wb-msg" class="msg"></div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>特殊BOSS设置</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <p style="color: #666; margin-bottom: 6px; font-size: 13px;">基础属性（魔龙BOSS、暗之系列BOSS、沙巴克BOSS）</p>
            <div class="row" style="margin-bottom: 4px; font-size: 13px; gap: 4px;">
              <label style="min-width: 40px;">生命:</label>
              <input id="sb-base-hp" type="number" min="1" style="width: 90px; font-size: 13px; padding: 4px 6px;">
              <label style="min-width: 40px;">攻击:</label>
              <input id="sb-base-atk" type="number" min="1" style="width: 90px; font-size: 13px; padding: 4px 6px;">
            </div>
            <div class="row" style="margin-bottom: 4px; font-size: 13px; gap: 4px;">
              <label style="min-width: 40px;">防御:</label>
              <input id="sb-base-def" type="number" min="1" style="width: 90px; font-size: 13px; padding: 4px 6px;">
              <label style="min-width: 40px;">魔御:</label>
              <input id="sb-base-mdef" type="number" min="1" style="width: 90px; font-size: 13px; padding: 4px 6px;">
            </div>
            <div class="row" style="margin-bottom: 6px; font-size: 13px; gap: 4px;">
              <label style="min-width: 40px;">掉落加成:</label>
              <input id="sb-drop-bonus" type="number" min="1" step="0.1" style="width: 90px; font-size: 13px; padding: 4px 6px;">
            </div>

            <p style="color: #666; margin: 10px 0 6px; font-size: 13px;">人数加成配置</p>
            <div class="table-container">
              <table style="font-size: 12px;">
                <thead>
                  <tr>
                    <th style="padding: 6px 8px;">最小人数</th>
                    <th style="padding: 6px 8px;">生命加成</th>
                    <th style="padding: 6px 8px;">攻击加成</th>
                    <th style="padding: 6px 8px;">防御加成</th>
                    <th style="padding: 6px 8px;">魔御加成</th>
                    <th style="padding: 6px 8px;">操作</th>
                  </tr>
                </thead>
                <tbody id="sb-player-bonus-list">
                  <tr>
                    <td colspan="6" style="text-align: center; color: #999;">点击加载获取数据</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="row" style="margin-top: 8px;">
              <button id="sb-add-bonus-btn" class="btn-small">+ 添加配置</button>
              <button id="sb-save-btn" class="btn-small">保存</button>
            </div>
            <div id="sb-msg" class="msg"></div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>VIP 设置</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <div style="margin-bottom: 20px;">
              <h3>VIP 自助激活开关</h3>
              <p>当前状态: <span id="vip-self-claim-status">加载中...</span></p>
              <label class="admin-switch">
                <input type="checkbox" id="vip-self-claim-toggle">
                <span class="admin-switch-slider" aria-hidden="true"></span>
                <span class="admin-switch-label">开启自助激活</span>
              </label>
              <div id="vip-self-claim-msg" class="msg"></div>
            </div>

            <div style="border-top: 1px solid #ddd; padding-top: 20px;">
              <h3>VIP 激活码管理</h3>
              <input id="vip-count" type="number" min="1" max="100" value="5">
              <button id="vip-create-btn">生成激活码</button>
              <button id="vip-list-btn">查看激活码列表</button>
              <div id="vip-codes-result" class="list"></div>
              
              <div class="table-container" id="vip-codes-table-container" style="display: none;">
                <table>
                  <thead>
                    <tr>
                      <th>激活码</th>
                      <th>状态</th>
                      <th>使用者ID</th>
                      <th>使用时间</th>
                    </tr>
                  </thead>
                  <tbody id="vip-codes-list"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>掉落日志开关</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <p>当前状态: <span id="loot-log-status">加载中...</span></p>
            <label class="admin-switch">
              <input type="checkbox" id="loot-log-toggle">
              <span class="admin-switch-slider" aria-hidden="true"></span>
              <span class="admin-switch-label">开启掉落日志</span>
            </label>
            <div id="loot-log-msg" class="msg"></div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>状态刷新节流</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <p>当前状态: <span id="state-throttle-status">加载中...</span></p>
            <label class="admin-switch">
              <input type="checkbox" id="state-throttle-toggle">
              <span class="admin-switch-slider" aria-hidden="true"></span>
              <span class="admin-switch-label">开启节流</span>
            </label>
            <label class="admin-switch">
              <input type="checkbox" id="state-throttle-override-allowed">
              <span class="admin-switch-slider" aria-hidden="true"></span>
              <span class="admin-switch-label">允许前台正常刷新影响服务端</span>
            </label>
            <div class="row" style="margin-top: 6px;">
              <input id="state-throttle-interval" type="number" min="1" value="10" style="max-width: 120px;">
              <button id="state-throttle-save" class="btn-small">保存秒数</button>
            </div>
            <div id="state-throttle-msg" class="msg"></div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>寄售到期设置</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <p>当前状态: <span id="consign-expire-status">加载中...</span></p>
            <div class="row" style="margin-top: 6px;">
              <input id="consign-expire-hours" type="number" min="0" value="48" style="max-width: 120px;">
              <button id="consign-expire-save" class="btn-small">保存小时</button>
            </div>
            <p class="muted" style="margin-top: 6px;">0 表示不自动下架</p>
            <div id="consign-expire-msg" class="msg"></div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>房间变种数量</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <p>当前状态: <span id="room-variant-status">加载中...</span></p>
            <div class="row" style="margin-top: 6px;">
              <input id="room-variant-count" type="number" min="1" value="5" style="max-width: 120px;">
              <button id="room-variant-save" class="btn-small">保存数量</button>
            </div>
            <p class="muted" style="margin-top: 6px;">修改后立即生效；减少时仅影响分流选择</p>
            <div id="room-variant-msg" class="msg"></div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>修炼果设置</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <div style="margin-bottom: 20px;">
              <h3>修炼果系数</h3>
              <p style="color: #666; margin-bottom: 8px; font-size: 13px;">
                控制修炼果对属性的加成效果。系数越大，每个修炼果提供的属性加成越高。<br>
                默认值: 0.5（每个修炼果+0.5点属性）
              </p>
            </div>

            <div style="border-top: 1px solid #ddd; padding-top: 20px; margin-bottom: 12px;">
              <h3>修炼果爆率</h3>
              <p style="color: #666; margin-bottom: 12px; font-size: 13px;">
                控制全地图怪物掉落修炼果的概率和离线挂机获取修炼果的概率。<br>
                默认值: 0.01（1%概率），范围: 0-1
              </p>
              <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <div class="row" style="margin-bottom: 8px; width: 45%; min-width: 180px;">
                  <label style="min-width: 50px;">系数:</label>
                  <input id="tf-coefficient" type="number" step="0.1" min="0" style="max-width: 80px;">
                </div>
                <div class="row" style="margin-bottom: 8px; width: 45%; min-width: 180px;">
                  <label style="min-width: 50px;">爆率:</label>
                  <input id="tf-drop-rate" type="number" step="0.001" min="0" max="1" style="max-width: 80px;">
                </div>
              </div>
            </div>
            <button id="tf-save-btn" class="btn-small">保存设置</button>
            <div id="tf-msg" class="msg"></div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>修炼系统设置</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <div style="margin-bottom: 20px;">
              <h3>修炼系统每级效果配置</h3>
              <p style="color: #666; margin-bottom: 12px; font-size: 13px;">
                控制修炼系统每次修炼提升的属性值。<br>
                默认值: 生命/魔法值=1, 其他属性=0.1
              </p>
              <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                <div class="row" style="margin-bottom: 8px; width: 45%; min-width: 180px;">
                  <label style="min-width: 50px;">生命:</label>
                  <input id="training-hp" type="number" step="0.1" min="0" style="max-width: 70px;">
                </div>
                <div class="row" style="margin-bottom: 8px; width: 45%; min-width: 180px;">
                  <label style="min-width: 50px;">魔法值:</label>
                  <input id="training-mp" type="number" step="0.1" min="0" style="max-width: 70px;">
                </div>
                <div class="row" style="margin-bottom: 8px; width: 45%; min-width: 180px;">
                  <label style="min-width: 50px;">攻击:</label>
                  <input id="training-atk" type="number" step="0.01" min="0" style="max-width: 70px;">
                </div>
                <div class="row" style="margin-bottom: 8px; width: 45%; min-width: 180px;">
                  <label style="min-width: 50px;">防御:</label>
                  <input id="training-def" type="number" step="0.01" min="0" style="max-width: 70px;">
                </div>
                <div class="row" style="margin-bottom: 8px; width: 45%; min-width: 180px;">
                  <label style="min-width: 50px;">魔法:</label>
                  <input id="training-mag" type="number" step="0.01" min="0" style="max-width: 70px;">
                </div>
                <div class="row" style="margin-bottom: 8px; width: 45%; min-width: 180px;">
                  <label style="min-width: 50px;">魔御:</label>
                  <input id="training-mdef" type="number" step="0.01" min="0" style="max-width: 70px;">
                </div>
                <div class="row" style="margin-bottom: 8px; width: 45%; min-width: 180px;">
                  <label style="min-width: 50px;">道术:</label>
                  <input id="training-spirit" type="number" step="0.01" min="0" style="max-width: 70px;">
                </div>
                <div class="row" style="margin-bottom: 12px; width: 45%; min-width: 180px;">
                  <label style="min-width: 50px;">敏捷:</label>
                  <input id="training-dex" type="number" step="0.01" min="0" style="max-width: 70px;">
                </div>
              </div>
              <button id="training-save-btn" class="btn-small">保存设置</button>
              <div id="training-msg" class="msg"></div>
            </div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>职业升级属性配置</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <div style="margin-bottom: 12px;">
              <label for="class-select" style="font-weight: bold;">选择职业:</label>
              <select id="class-select" style="max-width: 150px; margin-left: 8px;">
                <option value="warrior">战士</option>
                <option value="mage">法师</option>
                <option value="taoist">道士</option>
              </select>
            </div>
            <div class="table-container">
              <table style="font-size: 12px;">
                <thead>
                  <tr>
                    <th style="padding: 6px 8px;">属性</th>
                    <th style="padding: 6px 8px;">每级增加</th>
                    <th style="padding: 6px 8px;">属性</th>
                    <th style="padding: 6px 8px;">每级增加</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>HP</td>
                    <td><input id="class-bonus-hp" type="number" step="0.1" style="width: 60px;"></td>
                    <td>MP</td>
                    <td><input id="class-bonus-mp" type="number" step="0.1" style="width: 60px;"></td>
                  </tr>
                  <tr>
                    <td>攻击</td>
                    <td><input id="class-bonus-atk" type="number" step="0.1" style="width: 60px;"></td>
                    <td>防御</td>
                    <td><input id="class-bonus-def" type="number" step="0.1" style="width: 60px;"></td>
                  </tr>
                  <tr>
                    <td>魔法</td>
                    <td><input id="class-bonus-mag" type="number" step="0.1" style="width: 60px;"></td>
                    <td>魔御</td>
                    <td><input id="class-bonus-mdef" type="number" step="0.1" style="width: 60px;"></td>
                  </tr>
                  <tr>
                    <td>道术</td>
                    <td><input id="class-bonus-spirit" type="number" step="0.1" style="width: 60px;"></td>
                    <td>敏捷</td>
                    <td><input id="class-bonus-dex" type="number" step="0.1" style="width: 60px;"></td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="row" style="margin-top: 12px;">
              <button id="class-bonus-save" class="btn-small">保存配置</button>
              <button id="class-bonus-reset" class="btn-small" style="background: #c00;">恢复默认</button>
            </div>
            <div id="class-bonus-msg" class="msg"></div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>赞助名单管理</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <p class="muted" style="margin-bottom: 8px;">玩家名和金额由GM在后台设置，在前台显示前5位</p>
            <div class="row" style="margin-bottom: 8px;">
              <input id="sponsor-name" type="text" placeholder="玩家名" style="max-width: 150px;">
              <input id="sponsor-amount" type="number" min="0" placeholder="金额" style="max-width: 100px;">
              <button id="sponsor-add-btn" class="btn-small">添加</button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>排名</th>
                    <th>玩家名</th>
                    <th>金额</th>
                    <th>添加时间</th>
                    <th>操作</th>
                  </tr>
                </thead>
                <tbody id="sponsors-list">
                  <tr>
                    <td colspan="5" style="text-align: center; color: #999;">加载中...</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="row" style="margin-top: 12px;">
              <div id="sponsors-pagination-info" style="color: #666;"></div>
              <div>
                <button id="sponsors-prev-page" class="btn-small">上一页</button>
                <button id="sponsors-next-page" class="btn-small">下一页</button>
              </div>
            </div>
            <div id="sponsor-msg" class="msg"></div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>合区操作</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <p style="color: #c00; margin-bottom: 8px;">⚠️ 合区会强制下线所有玩家，请谨慎操作！</p>
            <div class="row" style="margin-bottom: 8px;">
              <label for="merge-source-realm">源区服:</label>
              <select id="merge-source-realm" style="max-width: 200px;"></select>
            </div>
            <div class="row" style="margin-bottom: 8px;">
              <label for="merge-target-realm">目标区服:</label>
              <select id="merge-target-realm" style="max-width: 200px;"></select>
            </div>
            <button id="merge-realms-btn" class="btn-small" style="background: #c00;">执行合区</button>
            <div id="merge-msg" class="msg"></div>
          </div>
        </div>

        <div class="block" data-collapsible>
          <div class="block-title">
            <h2>数据备份与导入</h2>
            <button class="btn-small block-toggle">折叠</button>
          </div>
          <div class="block-body">
            <p style="color: #666;">导入会覆盖当前全部数据，建议停服或确保无在线玩家。</p>
            <button id="backup-download">下载备份</button>
            <input id="import-file" type="file" accept="application/json">
            <button id="import-btn">导入备份</button>
            <div id="backup-msg" class="msg"></div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div id="admin-pw-modal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-title" id="admin-pw-title">修改密码</div>
      <div class="modal-text" id="admin-pw-text"></div>
      <input id="admin-pw-input" type="password" placeholder="新密码">
      <div class="modal-actions">
        <button id="admin-pw-cancel" class="btn-small">取消</button>
        <button id="admin-pw-submit">更新</button>
      </div>
    </div>
  </div>

  <!-- 通用确认对话框 -->
  <div id="confirm-modal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-title" id="confirm-title">确认操作</div>
      <div class="modal-text" id="confirm-text"></div>
      <div class="modal-actions">
        <button id="confirm-cancel" class="btn-small">取消</button>
        <button id="confirm-ok" class="btn-small">确定</button>
      </div>
    </div>
  </div>

  <!-- 通用提示对话框 -->
  <div id="alert-modal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-title" id="alert-title">提示</div>
      <div class="modal-text" id="alert-text"></div>
      <div class="modal-actions">
        <button id="alert-ok" class="btn-small">确定</button>
      </div>
    </div>
  </div>

  <!-- 通用输入对话框 -->
  <div id="prompt-modal" class="modal hidden">
    <div class="modal-card">
      <div class="modal-title" id="prompt-title">输入</div>
      <div class="modal-text" id="prompt-text"></div>
      <input id="prompt-input" type="text">
      <div class="modal-actions">
        <button id="prompt-cancel" class="btn-small">取消</button>
        <button id="prompt-ok" class="btn-small">确定</button>
      </div>
    </div>
  </div>

  <script src="admin.js?v=3"></script>
</body>
</html>
